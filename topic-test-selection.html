<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Topic-wise Test Selection - EduAssess Pro</title>
    <link rel="stylesheet" href="styles/main.css">
</head>
<body>
    <nav class="navbar">
        <div class="nav-container">
            <div class="nav-logo">
                <h2>EduAssess Pro</h2>
            </div>
            <div class="nav-links">
                <a href="index.html">Home</a>
                <a href="test-selection.html">Back to Tests</a>
            </div>
        </div>
    </nav>

    <main class="container">
        <div class="text-center" style="margin: 3rem 0;">
            <h1>ðŸ“š Topic-wise Test Selection</h1>
            <p>Select topics from different subjects for your test</p>
            <p><small>ðŸ“… Questions from 2023 Database</small></p>
        </div>

        <div class="card" style="max-width: 1000px; margin: 0 auto;">
            <!-- Debug Information -->
            <div id="debugInfo" style="background: #f0f0f0; padding: 10px; margin-bottom: 20px; border-radius: 5px; font-family: monospace; font-size: 12px;">
                <strong>Debug Info:</strong><br>
                <span id="debugText">Loading 2023 topic questions...</span>
            </div>

            <div class="mb-lg">
                <h3>Available Topics by Subject</h3>
                <div id="subjectsContainer">
                    <!-- Topics will be loaded here -->
                </div>
            </div>

            <div class="mb-lg">
                <h3>Selected Topics</h3>
                <div id="selectedTopics" class="selected-topics-display">
                    <p>No topics selected yet.</p>
                </div>
            </div>

            <div class="text-center">
                <button id="startTopicTest" class="btn btn-primary btn-large" disabled>
                    Start Topic Test
                </button>
            </div>
        </div>
    </main>

    <!-- Load ONLY 2023 questions for topic tests -->
    <script src="js/questions2023.js"></script>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Loading Topic Test Selection - 2023 Database');
            
            const subjectsContainer = document.getElementById('subjectsContainer');
            const selectedTopicsDisplay = document.getElementById('selectedTopics');
            const startButton = document.getElementById('startTopicTest');
            const debugText = document.getElementById('debugText');
            
            let selectedTopics = [];

            // Debug function
            function updateDebugInfo(message) {
                console.log('Debug:', message);
                debugText.innerHTML += message + '<br>';
            }

            // Function to extract topics grouped by subject - ONLY from 2023 data
            function getTopicsBySubject() {
                updateDebugInfo('Starting topic extraction from 2023 database...');
                
                // Check if 2023 question array exists
                const questions2023 = typeof topicQuestions2023 !== 'undefined' ? topicQuestions2023 : [];
                
                updateDebugInfo(`Found ${questions2023.length} questions from 2023 database`);
                
                if (questions2023.length === 0) {
                    updateDebugInfo('ERROR: No 2023 topic questions found! Check if questions2023.js is loaded correctly.');
                    return {};
                }

                const topicsBySubject = {};

                questions2023.forEach((question, index) => {
                    if (!question.subject || !question.topic) {
                        updateDebugInfo(`Warning: Question ${index} missing subject or topic properties`);
                        return;
                    }
                    
                    const subject = question.subject;
                    const topic = question.topic;

                    if (!topicsBySubject[subject]) {
                        topicsBySubject[subject] = new Set();
                    }
                    topicsBySubject[subject].add(topic);
                });

                // Convert Sets to Arrays and sort
                Object.keys(topicsBySubject).forEach(subject => {
                    topicsBySubject[subject] = Array.from(topicsBySubject[subject]).sort();
                    updateDebugInfo(`${subject}: ${topicsBySubject[subject].length} topics`);
                });

                updateDebugInfo(`Subjects found in 2023 database: ${Object.keys(topicsBySubject).join(', ')}`);
                return topicsBySubject;
            }

            // Function to render topics
            function renderTopics() {
                updateDebugInfo('Starting to render topics from 2023 database...');
                const topicsBySubject = getTopicsBySubject();
                
                if (Object.keys(topicsBySubject).length === 0) {
                    subjectsContainer.innerHTML = '<p style="color: red;">No topics found in 2023 database. Please check your questions2023.js file.</p>';
                    return;
                }

                subjectsContainer.innerHTML = '';

                Object.keys(topicsBySubject).sort().forEach(subject => {
                    updateDebugInfo(`Rendering subject: ${subject}`);
                    
                    const subjectDiv = document.createElement('div');
                    subjectDiv.className = 'subject-section';
                    subjectDiv.style.marginBottom = '2rem';
                    subjectDiv.style.border = '1px solid #ddd';
                    subjectDiv.style.borderRadius = '8px';
                    subjectDiv.style.padding = '15px';

                    const subjectHeader = document.createElement('h4');
                    subjectHeader.textContent = `ðŸ“– ${subject}`;
                    subjectHeader.style.color = '#3498db';
                    subjectHeader.style.marginBottom = '1rem';
                    subjectHeader.style.cursor = 'pointer';
                    subjectDiv.appendChild(subjectHeader);

                    const topicsGrid = document.createElement('div');
                    topicsGrid.className = 'topics-grid';
                    topicsGrid.style.display = 'grid';
                    topicsGrid.style.gridTemplateColumns = 'repeat(auto-fill, minmax(250px, 1fr))';
                    topicsGrid.style.gap = '10px';
                    topicsGrid.style.marginBottom = '1rem';

                    topicsBySubject[subject].forEach(topic => {
                        const topicItem = document.createElement('div');
                        topicItem.className = 'topic-item';
                        topicItem.style.cssText = `
                            background: #f8f9fa;
                            border: 2px solid #e9ecef;
                            border-radius: 8px;
                            padding: 12px;
                            cursor: pointer;
                            transition: all 0.3s ease;
                            user-select: none;
                        `;

                        const checkbox = document.createElement('input');
                        checkbox.type = 'checkbox';
                        checkbox.id = `topic-${subject}-${topic}`;
                        checkbox.value = `${subject}|${topic}`;
                        checkbox.style.marginRight = '8px';

                        const label = document.createElement('label');
                        label.htmlFor = checkbox.id;
                        label.textContent = topic;
                        label.style.cursor = 'pointer';
                        label.style.fontSize = '14px';
                        label.style.fontWeight = '500';

                        topicItem.appendChild(checkbox);
                        topicItem.appendChild(label);

                        // Add click event to the entire item
                        topicItem.addEventListener('click', function(e) {
                            if (e.target !== checkbox) {
                                checkbox.checked = !checkbox.checked;
                                checkbox.dispatchEvent(new Event('change'));
                            }
                        });

                        // Add change event to checkbox
                        checkbox.addEventListener('change', function() {
                            if (this.checked) {
                                topicItem.style.backgroundColor = '#e3f2fd';
                                topicItem.style.borderColor = '#2196f3';
                                addSelectedTopic(subject, topic);
                            } else {
                                topicItem.style.backgroundColor = '#f8f9fa';
                                topicItem.style.borderColor = '#e9ecef';
                                removeSelectedTopic(subject, topic);
                            }
                        });

                        topicsGrid.appendChild(topicItem);
                    });

                    subjectDiv.appendChild(topicsGrid);
                    subjectsContainer.appendChild(subjectDiv);
                });
                
                updateDebugInfo('Topic rendering completed from 2023 database!');
            }

            // Function to add selected topic
            function addSelectedTopic(subject, topic) {
                const topicKey = `${subject}|${topic}`;
                if (!selectedTopics.some(t => t.key === topicKey)) {
                    selectedTopics.push({ key: topicKey, subject, topic });
                    updateSelectedTopicsDisplay();
                }
            }

            // Function to remove selected topic
            function removeSelectedTopic(subject, topic) {
                const topicKey = `${subject}|${topic}`;
                selectedTopics = selectedTopics.filter(t => t.key !== topicKey);
                updateSelectedTopicsDisplay();
            }

            // Function to update selected topics display
            function updateSelectedTopicsDisplay() {
                if (selectedTopics.length === 0) {
                    selectedTopicsDisplay.innerHTML = '<p>No topics selected yet.</p>';
                    startButton.disabled = true;
                } else {
                    const groupedTopics = {};
                    selectedTopics.forEach(t => {
                        if (!groupedTopics[t.subject]) {
                            groupedTopics[t.subject] = [];
                        }
                        groupedTopics[t.subject].push(t.topic);
                    });

                    let html = '<div class="selected-topics-list">';
                    Object.keys(groupedTopics).forEach(subject => {
                        html += `<div class="selected-subject">
                            <strong>${subject}:</strong> ${groupedTopics[subject].join(', ')}
                        </div>`;
                    });
                    html += '</div>';
                    
                    selectedTopicsDisplay.innerHTML = html;
                    startButton.disabled = false;
                    startButton.textContent = `Start Topic Test (${selectedTopics.length} topics)`;
                }
            }

            // Start test button event
            startButton.addEventListener('click', function() {
                if (selectedTopics.length > 0) {
                    const testConfig = {
                        mode: 'topic-test',
                        dataSource: '2023', // Add data source identifier
                        selectedTopics: selectedTopics.map(t => ({ subject: t.subject, topic: t.topic }))
                    };
                    
                    localStorage.setItem('testConfig', JSON.stringify(testConfig));
                    window.location.href = 'test.html';
                }
            });

            // Initialize the page
            try {
                renderTopics();
            } catch (error) {
                updateDebugInfo(`ERROR: ${error.message}`);
                console.error('Error rendering topics:', error);
            }
        });
    </script>
</body>
</html>
